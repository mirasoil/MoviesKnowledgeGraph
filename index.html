<!DOCTYPE html>
<html>
<head>
    <title>Robots</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<header>
  <h2>Robots by Categories</h2>
</header>
<div class="container">
   <button class="btn btn-info my-4" onclick="showList()">Show Categories</button>  
  <section>
    <div id="components">
      <label id="comp-label">Categories</label>
      <hr>
      <ul id="lista">
        
      </ul>
    </div>
    
    <div id="component-card">
      <h3 id="c-name">Robots</h3><hr>
      <table id="tableId">
        <thead>
          <tr>
            <th class="text-center" width="10%">Name</th>
            <th class="text-center" width="10%">Image</th>
            <th class="text-center" width="30%">Infos</th>
          </tr>
         </thead>
         <tbody>
           
           
        </tbody>
      </table>
    </div>
    
  </section>
  <form id="insertForm">
    <h4 class="my-4">Insert new robot</h4>
    <div class="form-group">
      <label for="denumire">Name*</label> <!--uri + label-->
      <input type="text" class="form-control" id="denumire" placeholder="Denumire" required>
    </div>
    <div class="form-group">
      <label for="manufacturer">Manufacturer*</label>
      <input type="text" class="form-control" id="manufacturer" placeholder="Manufacturer" required>
    </div>
    <div class="form-group">
      <label for="image">Image</label>
      <br>
      <input type="file" name="image" class="p-0" id="image">
    </div>
    <div class="form-group">
      <label for="skills">Skills</label>
      <input type="text" class="form-control" id="skills" placeholder="Skills">
    </div>
    <div class="form-group">
      <label for="sales">Sales</label><br>
      <input type="radio"  class="saleValue" name="saleValue" value="Yes" id="saleYes" /> Yes 
      <input type="radio"  class="saleValue" name="saleValue" value="No" id="saleNo" /> No
    </div>
    <div class="form-group">
      <label for="releaseDate">Release Date</label>
      <input type="date" class="form-control" id="releaseDate" placeholder="Release Date">
    </div>
    <div class="form-group">
      <label for="mass">Mass</label>
      <input type="number" class="form-control" id="mass" placeholder="Mass">
    </div>
    <!-- <button class="btn btn-primary de-inserat" onclick="trimite(this.id)">Insereaza</button> -->
    <button class="btn btn-primary de-inserat" onclick="insertRobot(this.id)">Insert</button>
  </form>
  <br>

<script>
  function showList() {
   var x = document.getElementById("components");
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}

bringCategories();

function bringCategories() {
  let url = 'select.php';

  $.ajax({
    type: "GET",
    url: url,
	 success: function (response) {
     let final = JSON.parse(response)
    //  console.log(final.results.bindings);
    final.results.bindings.forEach((item, index)=>{
      $( "#lista" ).append( "<li class='mt-4'><a href='#' onclick='getDetails(this.id)' id='"+item.categorie.value+ "' class='text-decoration-none text-dark' ><b>" + item['nume'].value + "</b></a> </li> "  );
      })
    }
  });
}


//needs second check on rdfs:label
function getDetailsOk(id) {
  console.log(id);
  let url = "query.php";
  $.ajax({
    type: "POST",
    url:url,
    data: {"id": id },
    success: function (response){
      let final = JSON.parse(response);
      console.log(final.results);
      $('#tableId').find('tbody')
          .empty();

      final.results.bindings.forEach((item, index)=>{   
        console.log(item);
        if (item.numeRobot) { 
          s = item.numeRobot.value;
          id = s.split(" ").join("");  //titlul filmelor il transformam in id prin eliminarea spatiilor si concatenarea cuvintelor

             $('#tableId').find('tbody')
                .append($(`<tr id=${id} class="border_bottom">`)
                  .append($('<td class="mt-3 text-center">')
                    .append(`<p class='mt-4'><b><i>${item.numeRobot.value} </i></b></p><br><button class='btn btn-danger' id='${item.id.value}' onclick="deleteRobot(this.id, '${id}')">Sterge</button></div>`)
                  )
                  .append($('<td class="text-center">')
                    .append($('<img height="150" width="250">')
                      .attr('src', 'images/'+item.image.value)
                    )
                  )
                  .append($('<td>')
                    .append($('<p><small><b> Manufacturer: </b>'+ item.manufacturer.value+ '</small><br><small><b>Release date: </b>' + item.releaseDate.value +'</small><br><small><b>Skills: </b>'+item.skills.value +'</small><br><small> <b>Mass: </b>'+item.mass.value + ' kg</small><br><small> <b>Sale: </b>'+ ((item.sale.value == "true") ? 'Yes' : 'No') + '</small></p>'))
                  )
                )     
        }
        let button = document.querySelector('.de-inserat');
        button.setAttribute("id", item.category.value);   //setam id-ul butonului ca fiind uri-ul actorului => inserarea se face pe baza atributului
    })   
    }
  });
}
function getDetails(id) {
  console.log(id);
  let url = "query.php";
  $.ajax({
    type: "POST",
    url:url,
    data: {"id": id },
    success: function (response){
      let final = JSON.parse(response);
      console.log(final.results);
      $('#tableId').find('tbody')
          .empty();

      final.results.bindings.forEach((item, index)=>{   
        console.log(item);
        // if (item.numeRobot && item.manufacturer && item.image.value !== "default.png" && item.releaseDate.value !== "1999-01-01" && item.skills.value !== "unknown" && item.mass.value !== 0 && item.sale.value !== "unknown") { 
        if (item.numeRobot && item.manufacturer) { 
          s = item.numeRobot.value;
          id = s.split(" ").join("");  

             $('#tableId').find('tbody')
                .append($(`<tr id=${id} class="border_bottom">`)
                  .append($('<td class="mt-3 text-center">')
                    .append(`<p class='mt-4'><b><i>${item.numeRobot.value} </i></b></p><br><button class='btn btn-danger' id='${item.id.value}' onclick="deleteRobot(this.id, '${id}')">Sterge</button></div>`)
                  )
                  .append($('<td class="text-center">')
                    .append($('<img height="150" width="250">')
                      .attr('src', 'images/'+((item.image.value !== "default.png") ? item.image.value : 'default.png'))
                    )
                  )
                  .append($('<td>')
                    .append($('<p><small><b> Manufacturer: </b>'+ item.manufacturer.value+ '</small><br><small><b>Release date: </b>' + ((item.releaseDate.value !== "1999-01-01") ? item.releaseDate.value : '') +'</small><br><small><b>Skills: </b>'+ ((item.skills.value !== "unknown") ? item.skills.value : '')+'</small><br><small> <b>Mass: </b>'+((item.mass.value == 0) ? ' altceva ' : item.mass.value +' kg') + '</small><br><small> <b>Sale: </b>'+ ((item.sale.value !== "unknown") ? ((item.sale.value == "true") ? "Yes" : "No") : '') + '</small></p>'))
                  )
                )   
             
        } 
        let button = document.querySelector('.de-inserat');
        button.setAttribute("id", item.category.value);   //setam id-ul butonului ca fiind uri-ul actorului => inserarea se face pe baza atributului
    })   
    }
  });
}

//deletes using unique uri
function deleteRobot(uri, sterge) {
  console.log(uri, sterge);
  $.ajax({
    type: "POST",
    url:"delete.php",
    data: {
      uri: uri
    },
    success: function(response) {
      $("#"+sterge).remove();
    }
  })
}

function insertRobot(category) {
  //uri = id categorie
  let url = "insert.php";
  console.log(category)
  let uriNou = $('#denumire').val();
  let manufacturer = $('#manufacturer').val();
  let filename = $('input[type="file"]').val().split("\\");  
  let imageInitial = filename[filename.length - 1];  
  if(imageInitial == '') {
    image = "default.png";
  } else {
    image = imageInitial;
  }
  let skillsInitial = $('#skills').val();
  if(skillsInitial == '') {
    skills = "unknown";
  } else {
    skills = skillsInitial;
  }
  let salesInitial = $(".saleValue:checked").val();
  console.log(salesInitial)
  if(!salesInitial) {
    sale = "unknown";
  } else {
    if (salesInitial == "Yes") {
      sale = true;
    } else {
      sale = false;
    }
  }
  let releaseDateInitial = $('#releaseDate').val();
  if(releaseDateInitial == '') {
    releaseDate = "1999-01-01";
  } else {
    releaseDate = releaseDateInitial;
  }
  let massInitial = $('#mass').val();
  if(massInitial == '') {
    mass = 0;
  } else {
    mass = massInitial;
  }
  console.log('1', image, '2', skills, '3', sale, '4',  releaseDate, '5', mass)

  $.ajax({
    type: "POST",
    url:url,
    dataType: "json",
    data: {
      category: category,
      uriNou: uriNou,
      manufacturer: manufacturer,
      image: image,
      skills: skills,
      sale: sale,
      releaseDate: releaseDate,
      mass: mass
    },
    // success: function(response) {
    //   console.log(response.responseText);
    //   // var dataResult = JSON.parse(response);
    //   if(response.status==200){
    //       alert('ok');
    //       console.log(response.responseText);
    //   } else {
    //       alert('Acest URI exista deja in baza de date')
    //       console.log(response.responseText)
    //   }
    // }
    success : function(data) {
      alert(data);
      $('#tableId').load();
      var dataResult = JSON.parse(data);
      if(dataResult.status==200){
          alert('ok');
          console.log(dataResult.success);
      }
    },
    error: function(error)
    {
        console.log(error.responseText);
        alert('Acest URI exista deja in baza de date');
    }
  })
}

</script>
</body>
</html>